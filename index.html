<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Post Dashboard | Workspaces</title>
    <style>
        :root {
            --bg-color: #fcfcfc;
            --text-main: #1a1a1a;
            --text-muted: #8e8e8e;
            --accent: #fe2c55;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-wrapper {
            max-width: 800px;
            margin: 80px auto;
                function hideMenus() {
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
                      <title>Multipost | Workspaces</title>
                      <style>
                        :root {
                          --bg-1: #0f172a;
                          --bg-2: #1e293b;
                          --card: rgba(30, 41, 59, 0.7);
                          --muted: #94a3b8;
                          --text: #e5e7eb;
                          --primary: #3b82f6;
                          --primary-2: #6366f1;
                          --border: rgba(255, 255, 255, 0.08);
                          --glass: rgba(255, 255, 255, 0.06);
                        }

                        * { box-sizing: border-box; }
                        body {
                          margin: 0;
                          font-family: 'Inter', -apple-system, system-ui, sans-serif;
                          background: radial-gradient(circle at top left, var(--bg-2), var(--bg-1));
                          color: var(--text);
                          min-height: 100vh;
                          display: flex;
                          justify-content: center;
                          padding: 32px 16px 48px;
                        }

                        .app {
                          width: 100%;
                          max-width: 560px;
                          background: var(--glass);
                          border: 1px solid var(--border);
                          border-radius: 28px;
                          padding: 28px;
                          box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
                          backdrop-filter: blur(18px);
                        }

                        .header {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 16px;
                          margin-bottom: 22px;
                        }
                        .brand {
                          display: flex;
                          align-items: center;
                          gap: 12px;
                        }
                        .brand img { width: 64px; height: 64px; border-radius: 16px; }
                        .brand h1 { margin: 0; font-size: 22px; letter-spacing: -0.5px; }
                        .brand .muted { color: var(--muted); font-size: 13px; margin-top: 4px; }

                        #authBtn {
                          background: linear-gradient(135deg, var(--primary), var(--primary-2));
                          color: white;
                          border: none;
                          padding: 12px 16px;
                          border-radius: 14px;
                          font-weight: 700;
                          cursor: pointer;
                          box-shadow: 0 10px 30px rgba(59, 130, 246, 0.35);
                        }

                        .stats {
                          display: flex;
                          gap: 10px;
                          flex-wrap: wrap;
                          margin-bottom: 16px;
                        }
                        .pill {
                          background: rgba(255, 255, 255, 0.06);
                          border: 1px solid var(--border);
                          padding: 8px 12px;
                          border-radius: 12px;
                          font-size: 13px;
                          color: var(--muted);
                        }

                        .primary-btn {
                          width: 100%;
                          border: none;
                          background: linear-gradient(135deg, var(--primary), var(--primary-2));
                          color: white;
                          padding: 16px;
                          border-radius: 16px;
                          font-weight: 800;
                          margin: 14px 0 18px;
                          cursor: pointer;
                          box-shadow: 0 18px 40px rgba(59, 130, 246, 0.35);
                        }

                        .section-label {
                          text-transform: uppercase;
                          letter-spacing: 1px;
                          font-size: 12px;
                          color: var(--muted);
                          margin-bottom: 10px;
                        }

                        .folder-grid { display: grid; gap: 12px; }

                        .folder-card {
                          background: rgba(255, 255, 255, 0.04);
                          border: 1px solid var(--border);
                          border-radius: 18px;
                          padding: 14px;
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                        }
                        .f-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
                        .f-icon { width: 40px; height: 40px; border-radius: 12px; background: rgba(59,130,246,0.18); display: flex; align-items:center; justify-content:center; font-size: 18px; }
                        .f-name { margin: 0; font-weight: 700; }
                        .f-sub { margin: 2px 0 0; font-size: 12px; color: var(--muted); }

                        .actions { display: flex; align-items: center; gap: 8px; }
                        .dots-btn {
                          background: rgba(255,255,255,0.06);
                          border: 1px solid var(--border);
                          color: var(--text);
                          border-radius: 12px;
                          padding: 8px 10px;
                          cursor: pointer;
                        }
                        .arrow-icon {
                          width: 34px; height: 34px;
                          border-radius: 12px;
                          background: rgba(255,255,255,0.06);
                          border: 1px solid var(--border);
                          display: flex; align-items: center; justify-content: center;
                          color: var(--muted);
                          cursor: pointer;
                        }

                        .dropdown-menu {
                          position: absolute;
                          right: 12px;
                          top: 54px;
                          background: rgba(15,23,42,0.95);
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          box-shadow: 0 14px 40px rgba(0,0,0,0.45);
                          min-width: 180px;
                          overflow: hidden;
                          display: none;
                          z-index: 5;
                        }
                        .dropdown-menu button {
                          width: 100%;
                          padding: 12px 16px;
                          background: transparent;
                          color: var(--text);
                          border: none;
                          text-align: left;
                          cursor: pointer;
                        }
                        .dropdown-menu button:hover { background: rgba(255,255,255,0.06); }
                        .dropdown-menu .danger { color: #f87171; }

                        .empty-state {
                          text-align: center;
                          color: var(--muted);
                          padding: 30px 0;
                          border: 1px dashed var(--border);
                          border-radius: 14px;
                          background: rgba(255,255,255,0.02);
                        }
                      </style>
                    </head>
                    <body>
                      <div class="app">
                        <header class="header">
                          <div class="brand">
                            <img src="logo.png" alt="Multipost logo">
                            <div>
                              <h1>Workspaces</h1>
                              <div class="muted">Welcome back</div>
                            </div>
                          </div>
                          <button id="authBtn">Sign In</button>
                        </header>

                        <div class="stats">
                          <div class="pill" id="folderCountPill">0 Workspaces</div>
                          <div class="pill">Cloud Active</div>
                        </div>

                        <button class="primary-btn" onclick="createNewFolder()">+ Create New Workspace</button>

                        <div class="section-label">Your Clients</div>
                        <div class="folder-grid" id="folderContainer">
                          <div class="empty-state">Loading your cloud storage...</div>
                        </div>
                      </div>

                      <script>
                        const apiBase = "https://multipost-seo-worker.alexbryant.workers.dev/api";
                        const userScope = localStorage.getItem("currentUserKey") || "guest";
                        const scopedKey = name => `${name}:${userScope}`;

                        // Migrate legacy unscoped data into scoped keys
                        const legacyFolders = localStorage.getItem("folders");
                        if (!localStorage.getItem(scopedKey("folders")) && legacyFolders) {
                          localStorage.setItem(scopedKey("folders"), legacyFolders);
                          localStorage.removeItem("folders");
                        }

                        const legacyActiveId = localStorage.getItem("activeFolderId");
                        if (!localStorage.getItem(scopedKey("activeFolderId")) && legacyActiveId !== null) {
                          localStorage.setItem(scopedKey("activeFolderId"), legacyActiveId);
                          localStorage.removeItem("activeFolderId");
                        }

                        const legacyActiveName = localStorage.getItem("activeFolderName");
                        if (!localStorage.getItem(scopedKey("activeFolderName")) && legacyActiveName) {
                          localStorage.setItem(scopedKey("activeFolderName"), legacyActiveName);
                          localStorage.removeItem("activeFolderName");
                        }

                        function hideMenus() {
                          document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
                        }

                        function getActiveFolderId() {
                          const id = Number(localStorage.getItem(scopedKey('activeFolderId')));
                          return Number.isFinite(id) ? id : null;
                        }

                        let cachedFolders = [];

                        function renderFolders(folders) {
                          const container = document.getElementById("folderContainer");
                          const pill = document.getElementById("folderCountPill");

                          pill.innerText = `${folders.length} Workspaces`;

                          if (folders.length === 0) {
                            container.innerHTML = `<div class="empty-state">No workspaces yet. Click the button above to start.</div>`;
                            return;
                          }

                          container.innerHTML = folders.map(f => `
                            <div class="folder-card">
                              <div class="f-info" onclick="openFolder(${f.id}, '${f.name.replace(/'/g, "\\'")}')">
                                <div class="f-icon">üìÅ</div>
                                <div>
                                  <p class="f-name">${f.name}</p>
                                  <p class="f-sub">Managed Workspace</p>
                                </div>
                              </div>
                              <div class="actions">
                                <button class="dots-btn" aria-label="Folder menu" onclick="event.stopPropagation();toggleMenu(event, ${f.id})">‚ãØ</button>
                                <div class="arrow-icon" onclick="openFolder(${f.id}, '${f.name.replace(/'/g, "\\'")}')">‚Ä∫</div>
                              </div>
                              <div class="dropdown-menu" id="menu-${f.id}">
                                <button onclick="event.stopPropagation();renameFolder(${f.id}, '${f.name.replace(/'/g, "\\'")}')">Rename this folder</button>
                                <button class="danger" onclick="event.stopPropagation();deleteFolder(${f.id})">Delete</button>
                              </div>
                            </div>`).join('');
                        }

                        async function loadFolders() {
                          try {
                            const res = await fetch(`${apiBase}/get-folders`);
                            if (!res.ok) throw new Error("Failed to fetch folders");
                            cachedFolders = await res.json();
                            localStorage.setItem(scopedKey('folders'), JSON.stringify(cachedFolders));
                            renderFolders(cachedFolders);
                          } catch (err) {
                            console.error(err);
                            const local = JSON.parse(localStorage.getItem(scopedKey('folders')) || '[]');
                            cachedFolders = local;
                            renderFolders(local);
                          }
                        }

                        async function createNewFolder() {
                          const name = prompt("Enter Brand or Client Name:");
                          if (!name) return;

                          try {
                            const res = await fetch(`${apiBase}/add-folder`, {
                              method: "POST",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ name })
                            });
                            if (res.ok) loadFolders();
                            else alert("Error saving folder");
                          } catch (err) {
                            alert("Error saving folder");
                          }
                        }

                        function openFolder(id, name) {
                          localStorage.setItem(scopedKey("activeFolderId"), id);
                          localStorage.setItem(scopedKey("activeFolderName"), name);
                          window.location.href = `folder.html?id=${id}`;
                        }

                        window.toggleMenu = function(event, id) {
                          hideMenus();
                          const menu = document.getElementById('menu-' + id);
                          if (menu) menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                          event.stopPropagation();
                        };

                        window.renameFolder = async function(id, oldName) {
                          const input = prompt('Rename folder:', oldName);
                          const name = input ? input.trim() : '';
                          if (!name || name === oldName) return;
                          try {
                            const res = await fetch(`${apiBase}/rename-folder`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({ id, name })
                            });
                            if (!res.ok) {
                              const msg = await res.text();
                              throw new Error(msg || 'Error renaming folder');
                            }

                            if (getActiveFolderId() === id) {
                              localStorage.setItem(scopedKey('activeFolderName'), name);
                            }

                            cachedFolders = cachedFolders.map(f => f.id === id ? { ...f, name } : f);
                            renderFolders(cachedFolders);
                            hideMenus();
                            await loadFolders();
                          } catch (err) {
                            alert(err.message || 'Error renaming folder');
                          }
                        };

                        window.deleteFolder = async function(id) {
                          if (!confirm('Delete this folder? This cannot be undone.')) return;
                          try {
                            const res = await fetch(`${apiBase}/delete-folder`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({ id })
                            });
                            if (!res.ok) {
                              const msg = await res.text();
                              throw new Error(msg || 'Error deleting folder');
                            }

                            if (getActiveFolderId() === id) {
                              localStorage.removeItem(scopedKey('activeFolderId'));
                              localStorage.removeItem(scopedKey('activeFolderName'));
                            }

                            cachedFolders = cachedFolders.filter(f => f.id !== id);
                            renderFolders(cachedFolders);
                            hideMenus();
                            await loadFolders();
                          } catch (err) {
                            alert(err.message || 'Error deleting folder');
                          }
                        };

                        document.addEventListener('click', () => {
                          hideMenus();
                        });

                        function updateAuthBtn() {
                          const btn = document.getElementById('authBtn');
                          const email = localStorage.getItem('userEmail');
                          if (email) {
                            btn.textContent = 'Sign Out';
                            btn.onclick = function() {
                              if (confirm('Sign out?')) {
                                localStorage.removeItem('userEmail');
                                window.location.href = 'signin.html';
                              }
                            };
                          } else {
                            btn.textContent = 'Sign In';
                            btn.onclick = function() {
                              window.location.href = 'signin.html';
                            };
                          }
                        }
    
                        window.onload = function() {
                          loadFolders();
                          updateAuthBtn();
                        };
                      </script>
                    </body>
                    </html>

