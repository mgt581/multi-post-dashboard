      try {
        const res = await fetch(`${apiBase}/generate-seo`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const bodyText = await res.text();
        if (!res.ok) {
          throw new Error(`Server error: ${res.status} ${bodyText || ""}`.trim());
        }

        let json;
        try {
          json = JSON.parse(bodyText);
        } catch (e) {
          throw new Error("Bad JSON from server");
        }

        if (!json.success) throw new Error(json.error || "AI Error");

        const coerceToText = value => {
          if (Array.isArray(value)) return value.join(", ");
          if (value === null || value === undefined) return "";
          return String(value);
        };

        const parseJsonSafe = value => {
          if (!value) return null;
          if (typeof value !== "string") return value;
          const trimmed = value.trim();
          const fenced = trimmed.match(/```(?:json)?\s*([\s\S]*?)```/i);
          const body = fenced ? fenced[1].trim() : trimmed;
          try { return JSON.parse(body); } catch { return null; }
        };

        const raw = json?.data?.response ?? json?.data ?? json;
        const parsed = parseJsonSafe(raw) || raw || {};
        const d = parsed?.data ?? parsed ?? {};

        const youtube = d.youtube || {};
        const tiktok = d.tiktok || {};
        const facebook = d.facebook || {};

        const youtubeTitle =
          youtube.title ?? d.youtubeTitle ?? d.title ?? prompt;
        const fullDescription =
          youtube.description ??
          d.youtubeDescription ??
          d.fullDescription ??
          d.description ??
          prompt;
        const trendingKeywords =
          youtube.keywords ??
          youtube.tags ??
          d.trendingKeywords ??
          d.keywords ??
          "";

        statusEl.textContent = "AI response received";
        document.getElementById("ytTitle").value = coerceToText(youtubeTitle);
        document.getElementById("ytDesc").value = coerceToText(fullDescription);
        document.getElementById("ytKeywords").value = coerceToText(trendingKeywords);

        document.getElementById("ttAllInOne").value = coerceToText(
          tiktok.allInOne ??
          tiktok.all_in_one ??
          tiktok.caption ??
          d.tiktokAllInOne ??
          d.tiktokCaption ??
          d.tiktokText ??
          d.caption ??
          tiktok.text ??
          prompt
        );

        document.getElementById("fbTitle").value = coerceToText(
          facebook.title ?? d.facebookTitle ?? prompt
        );
        document.getElementById("fbDetails").value = coerceToText(
          facebook.descriptionAndTags ??
            d.facebookDetails ??
            facebook.description ??
            facebook.tags ??
            prompt
        );
      } catch (err) {

    <div class="card">
      <div class="section-title">YouTube</div>
      <div class="form-group">
        <label for="ytTitle">YouTube Title</label>
        <input id="ytTitle" placeholder="YouTube Title" />
      </div>
      <div class="form-group">
        <label for="ytDesc">Full Description</label>
        <textarea id="ytDesc" placeholder="Full Description"></textarea>
      </div>
      <div class="form-group">
        <label for="ytKeywords">20 Trending Keywords</label>
        <textarea id="ytKeywords" placeholder="20 Trending Keywords"></textarea>
      </div>
      <button class="btn secondary" onclick="copyYoutube()">ðŸš€ Copy & Go to YouTube</button>
    </div>

    <div class="card">
      <div class="section-title">TikTok</div>
      <div class="form-group">
        <label for="ttAllInOne">Title, Desc, Tags & Keywords</label>
        <textarea id="ttAllInOne" placeholder="Title, Desc, Tags & Keywords combined"></textarea>
      </div>
      <button class="btn secondary" onclick="copyGeneric('ttAllInOne', 'TikTok', 'https://www.tiktok.com/upload')">ðŸ“± Copy & Go to TikTok</button>
    </div>

    <div class="card">
      <div class="section-title">Facebook Reels</div>
      <div class="form-group">
        <label for="fbTitle">Reel Title</label>
        <input id="fbTitle" placeholder="Reel Title" />
      </div>
      <div class="form-group">
        <label for="fbDetails">Description, Tags & Keywords</label>
        <textarea id="fbDetails" placeholder="Description, Tags & Keywords"></textarea>
      </div>
      <button class="btn secondary" onclick="copyFB()">ðŸ“¸ Copy & Go to Facebook</button>
    </div>
  </div>

  <script>
    const apiBase = "https://multipost-seo-worker.alexbryant.workers.dev/api";

    async function generateSEO() {
      const prompt = document.getElementById("videoPrompt").value.trim();
      if (!prompt) return alert("Please describe your video!");

      const btn = document.getElementById("generateBtn");
      const statusEl = document.getElementById("status");
      const originalText = btn.innerText;
      btn.innerText = "Analyzing Trends...";
      btn.classList.add("loading");
      statusEl.textContent = "";

      try {
        const res = await fetch(`${apiBase}/generate-seo`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        if (!res.ok) {
          const bodyText = await res.text();
          throw new Error(`Server error: ${res.status} ${bodyText || ""}`.trim());
        }

          const json = await res.json();
          if (!json.success) throw new Error(json.error || "AI Error");

          // Parse model output even if it comes back as a fenced string
          const coerceToText = value => {
            if (Array.isArray(value)) return value.join(", ");
            if (value === null || value === undefined) return "";
            return String(value);
          };

          const parseJsonSafe = value => {
            if (!value) return null;
            if (typeof value !== "string") return value;
            const trimmed = value.trim();
            const fenced = trimmed.match(/```(?:json)?\s*([\s\S]*?)```/i);
            const body = fenced ? fenced[1].trim() : trimmed;
            try { return JSON.parse(body); } catch { return null; }
          };

          const raw = json?.data?.response ?? json?.data ?? json;
          const parsed = parseJsonSafe(raw) || raw || {};
          const d = parsed?.data ?? parsed ?? {};

          const youtube = d.youtube || {};
          const tiktok = d.tiktok || {};
          const facebook = d.facebook || {};

          const youtubeTitle =
            youtube.title ?? d.youtubeTitle ?? d.title ?? prompt;
          const fullDescription =
            youtube.description ??
            d.youtubeDescription ??
            d.fullDescription ??
            d.description ??
            prompt;
          const trendingKeywords =
            youtube.keywords ??
            youtube.tags ??
            d.trendingKeywords ??
            d.keywords ??
            "";

          statusEl.textContent = "AI response received";
          document.getElementById("ytTitle").value = coerceToText(youtubeTitle);
          document.getElementById("ytDesc").value = coerceToText(fullDescription);
          document.getElementById("ytKeywords").value = coerceToText(trendingKeywords);

          document.getElementById("ttAllInOne").value = coerceToText(
            tiktok.allInOne ??
            tiktok.all_in_one ??
            tiktok.caption ??
            d.tiktokAllInOne ??
            d.tiktokCaption ??
            d.tiktokText ??
            d.caption ??
            tiktok.text ??
            prompt
          );

          document.getElementById("fbTitle").value = coerceToText(
            facebook.title ?? d.facebookTitle ?? prompt
          );
          document.getElementById("fbDetails").value = coerceToText(
            facebook.descriptionAndTags ??
              d.facebookDetails ??
              facebook.description ??
              facebook.tags ??
              prompt
          );
      } catch (err) {
        console.error(err);
        statusEl.textContent = err.message;
        alert("Error: " + err.message);
      } finally {
        btn.innerText = originalText;
        btn.classList.remove("loading");
      }
    }

    function copyYoutube() {
      const title = document.getElementById("ytTitle").value;
      const desc = document.getElementById("ytDesc").value;
      const keywords = document.getElementById("ytKeywords").value;
      const text = `TITLE:\n${title}\n\nDESC:\n${desc}\n\nKEYWORDS:\n${keywords}`;
      navigator.clipboard.writeText(text).then(() => {
        alert("YouTube SEO Copied!");
        window.open("https://www.youtube.com/upload", "_blank");
      });
    }

    function copyFB() {
      const title = document.getElementById("fbTitle").value;
      const details = document.getElementById("fbDetails").value;
      const text = `TITLE:\n${title}\n\nDETAILS:\n${details}`;
      navigator.clipboard.writeText(text).then(() => {
        alert("Facebook SEO Copied!");
        window.open("https://www.facebook.com/reels/create", "_blank");
      });
    }

    function copyGeneric(id, name, url) {
      const text = document.getElementById(id).value;
      navigator.clipboard.writeText(text).then(() => {
        alert(name + " SEO Copied!");
        window.open(url, "_blank");
      });
    }

    document.getElementById("generateBtn").addEventListener("click", generateSEO);
  </script>
</body>
</html>
