<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Folder View | Multipost SEO</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Additional UI refinements for the account list */
    .status-connected { color: #10b981; font-weight: 600; }
    .status-disconnected { color: #6b7280; font-style: italic; }
    .account-card { transition: transform 0.2s ease; }
    .account-card:hover { transform: translateY(-2px); }
    .platform-icon-img { width: 32px; height: 32px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <a href="index.html" class="back-link">←</a> 
      <span class="title" id="title">Loading Workspace...</span>
    </header>
    
    <div class="card" style="margin:20px; border-left: 5px solid #6366f1;">
      <div style="padding: 5px 0;">
        <small style="text-transform: uppercase; color: #6366f1; font-weight: bold;">Current Workspace</small><br>
        <strong id="name" style="font-size: 1.4rem;">Folder</strong><br>
        <span id="count" style="color: #6b7280;">Checking accounts...</span>
      </div>
    </div>

    <section class="cards" id="accountList">
      <div style="text-align:center; padding: 40px; color: #9ca3af;">
        Loading your connected platforms...
      </div>
    </section>

    <div class="card" style="display:flex; flex-direction: column; gap:12px; margin:20px; background: #f9fafb;">
      <label style="font-size: 0.9rem; font-weight: 600; color: #374151;">Connect New Platform</label>
      <div style="display:flex; gap:10px;">
        <select id="platformSelect" style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db;">
          <option value="tiktok">TikTok</option>
          <option value="youtube">YouTube</option>
          <option value="facebook">Facebook</option>
        </select>
        <button class="btn-gradient" onclick="addAccount()" style="min-width: 100px;">Add</button>
      </div>
    </div>

    <div style="margin-top: 30px; padding-bottom: 50px;">
      <button class="btn-gradient" style="width:90%; margin: 0 auto; display:block; padding: 15px; font-size: 1.1rem;" onclick="location.href='create-post.html'">
        ✏️ Create New Post
      </button>
    </div>
  </div>

  <script>
    /**
     * MULTIPOST SEO - FOLDER VIEW LOGIC
     * Version: 2.1.0 (Secure Scoping)
     */

    // --- CONFIGURATION ---
    const apiBase = "https://multipost-seo-worker.alexbryant.workers.dev/api";
    const userScope = localStorage.getItem("currentUserKey");

    // Auth Guard
    if (!userScope) {
      console.warn("No user context found, redirecting to sign-in.");
      window.location.href = "signin.html";
    }

    const scopedKey = name => `${name}:${userScope}`;

    // --- LEGACY MIGRATION ---
    // Ensures users from the previous version don't lose their session
    (function migrateKeys() {
      const legacyId = localStorage.getItem("activeFolderId");
      if (userScope && !localStorage.getItem(scopedKey("activeFolderId")) && legacyId) {
        localStorage.setItem(scopedKey("activeFolderId"), legacyId);
        localStorage.removeItem("activeFolderId");
      }
      const legacyName = localStorage.getItem("activeFolderName");
      if (userScope && !localStorage.getItem(scopedKey("activeFolderName")) && legacyName) {
        localStorage.setItem(scopedKey("activeFolderName"), legacyName);
        localStorage.removeItem("activeFolderName");
      }
    })();

    const fId = localStorage.getItem(scopedKey("activeFolderId"));
    const activeFolderName = localStorage.getItem(scopedKey("activeFolderName")) || "Workspace";

    // Initialize UI
    document.getElementById("title").innerText = activeFolderName;
    document.getElementById("name").innerText = activeFolderName;

    if (!fId) {
      alert("No workspace selected. Please pick one from the dashboard.");
      window.location.href = "index.html";
    }

    // --- PLATFORM DEFINITIONS ---
    const platformMeta = {
      youtube: {
        name: "YouTube",
        logo: "https://cdn.simpleicons.org/youtube/FF0000",
        iconBg: "#fff0f0",
      },
      tiktok: {
        name: "TikTok",
        logo: "https://cdn.simpleicons.org/tiktok/000000",
        iconBg: "#f3f4f6",
      },
      facebook: {
        name: "Facebook",
        logo: "https://cdn.simpleicons.org/facebook/1877F2",
        iconBg: "#f0f7ff",
      },
    };

    /**
     * Fetch and render all accounts linked to this specific workspace
     */
    async function render() {
      const listContainer = document.getElementById("accountList");
      
      try {
        const url = `${apiBase}/get-accounts?folder_id=${fId}&user_id=${encodeURIComponent(userScope)}`;
        const res = await fetch(url);
        
        if (!res.ok) throw new Error("Failed to reach server");
        
        const accs = await res.json();
        document.getElementById("count").innerText = `${accs.length} total accounts connected`;

        // Group accounts by platform for organized rendering
        const grouped = accs.reduce((map, account) => {
          if (!map[account.platform]) map[account.platform] = [];
          map[account.platform].push(account);
          return map;
        }, {});

        const platformOrder = ["youtube", "tiktok", "facebook"];
        const cardsHTML = [];

        platformOrder.forEach(platform => {
          const meta = platformMeta[platform];
          const accounts = grouped[platform] || [];

          if (accounts.length === 0) {
            // Render a "Disconnected" state card
            cardsHTML.push(`
              <div class="card account-card" style="opacity: 0.7;">
                <div class="icon platform-icon" style="background:${meta.iconBg};">
                  <img class="platform-icon-img" src="${meta.logo}" alt="${meta.name}">
                </div>
                <div class="card-text">
                  <strong>${meta.name}</strong>
                  <div class="platform-row">
                    <span class="status status-disconnected">
                      <span class="status-dot" style="background: #9ca3af;"></span>
                      Not Linked
                    </span>
                  </div>
                </div>
                <button class="btn-ghost" onclick="addAccountDirectly('${platform}')">Link</button>
              </div>
            `);
          } else {
            // Render each connected account for this platform
            accounts.forEach(acc => {
              cardsHTML.push(`
                <div class="card account-card">
                  <div class="icon platform-icon" style="background:${meta.iconBg}; border: 1px solid #e5e7eb;">
                    <img class="platform-icon-img" src="${meta.logo}" alt="${meta.name}">
                  </div>
                  <div class="card-text">
                    <strong>${acc.nickname || 'Active Channel'}</strong>
                    <div class="platform-row">
                      <span class="status status-connected">
                        <span class="status-dot" style="background: #10b981;"></span>
                        Connected
                      </span>
                    </div>
                  </div>
                  <button class="btn-ghost" style="color: #ef4444;" onclick="removeAccount(${acc.id}, this)">Remove</button>
                </div>
              `);
            });
          }
        });

        listContainer.innerHTML = cardsHTML.join("");

      } catch (err) {
        console.error("Render Error:", err);
        listContainer.innerHTML = `<div class="card" style="color:red; text-align:center;">Error loading accounts. Please refresh.</div>`;
      }
    }

    /**
     * Handles account deletion with optimistic UI feedback
     */
    async function removeAccount(accountId, btnEl) {
      if (!confirm("Are you sure? You will need to re-authenticate to post to this account again.")) return;

      const originalContent = btnEl.innerHTML;
      btnEl.disabled = true;
      btnEl.innerHTML = "Wait...";

      try {
        const res = await fetch(`${apiBase}/delete-folder`, { 
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            id: accountId, 
            user_id: userScope,
            type: "account_only" // Tell worker we are only deleting the account link
          }),
        });

        const result = await res.json();
        if (result.success) {
          await render();
        } else {
          throw new Error(result.error || "Delete failed");
        }
      } catch (err) {
        alert(err.message);
        btnEl.disabled = false;
        btnEl.innerHTML = originalContent;
      }
    }

    /**
     * Orchestrates the OAuth Handshake
     */
    function addAccount() {
      const platform = document.getElementById("platformSelect").value;
      initiateOAuth(platform);
    }

    function addAccountDirectly(platform) {
      initiateOAuth(platform);
    }

    function initiateOAuth(platform) {
      if (!fId || !userScope) return alert("Session error. Please log in again.");

      // PACKAGING THE STATE: 
      // We send FolderID and UserID joined by a pipe. 
      // The Worker splits this after the redirect to know where to save the token.
      const state = btoa(`${fId}|${userScope}`); 
      const authUrl = `${apiBase}/auth/${platform}?state=${state}`;
      
      console.log(`Redirecting to ${platform} Auth...`);
      window.location.href = authUrl;
    }

    // Start UI
    window.onload = render;

    // Listen for visibility changes to refresh account status
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") render();
    });
  </script>
</body>
</html>
