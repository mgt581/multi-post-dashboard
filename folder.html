<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Folder View</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <a href="index.html">←</a> 
      <span class="title" id="title">Folder</span>
    </header>
    
    <div class="card" style="margin:20px;">
      <strong id="name">Name</strong><br>
      <span id="count">0 accounts</span>
    </div>

    <section class="cards" id="accountList"></section>

    <div class="card" style="display:flex; gap:10px; margin:20px;">
      <select id="platformSelect" style="flex:1;">
        <option value="tiktok">TikTok</option>
        <option value="youtube">YouTube</option>
        <option value="facebook">Facebook</option>
      </select>
      <button class="btn-gradient" onclick="addAccount()">Add</button>
    </div>
    <button class="btn-gradient" style="width:90%; margin: 0 auto; display:block;" onclick="location.href='create-post.html'">✏️ Create Post</button>
  </div>

  <script>
    // --- CONFIGURATION ---
    const apiBase = "https://multipost-seo-worker.alexbryant.workers.dev/api";
    const userScope = localStorage.getItem("currentUserKey");
    if (!userScope) {
      window.location.href = "signin.html";
    }
    const scopedKey = name => `${name}:${userScope}`;

    // Migrate legacy unscoped keys so existing users keep their context
    const legacyId = localStorage.getItem("activeFolderId");
    if (userScope && !localStorage.getItem(scopedKey("activeFolderId")) && legacyId) {
      localStorage.setItem(scopedKey("activeFolderId"), legacyId);
      localStorage.removeItem("activeFolderId");
    }

    const legacyName = localStorage.getItem("activeFolderName");
    if (userScope && !localStorage.getItem(scopedKey("activeFolderName")) && legacyName) {
      localStorage.setItem(scopedKey("activeFolderName"), legacyName);
      localStorage.removeItem("activeFolderName");
    }

    const fId = localStorage.getItem(scopedKey("activeFolderId"));
    const activeFolderName = localStorage.getItem(scopedKey("activeFolderName")) || "Folder";

    // UI Initialization
    document.getElementById("title").innerText = activeFolderName;
    document.getElementById("name").innerText = activeFolderName;

    if (!fId) {
      alert("No workspace selected for this account. Please pick a workspace from the home screen.");
      window.location.href = "index.html";
    }

    /**
     * Renders the accounts linked to this folder
     */
    const platformMeta = {
      youtube: {
        name: "YouTube",
        logo: "https://cdn.simpleicons.org/youtube/FF0000",
        iconBg: "#ffffff",
      },
      tiktok: {
        name: "TikTok",
        logo: "https://cdn.simpleicons.org/tiktok/000000",
        iconBg: "#ffffff",
      },
      facebook: {
        name: "Facebook",
        logo: "https://cdn.simpleicons.org/facebook/1877F2",
        iconBg: "#ffffff",
      },
    };

    async function render() {
      if (!fId) {
        console.error("No active folder ID found in localStorage.");
        return;
      }
      
      try {
        const res = await fetch(`${apiBase}/get-accounts?folder_id=${fId}&user_id=${encodeURIComponent(userScope)}`);
        const accs = await res.json();
        
        document.getElementById("count").innerText = `${accs.length} accounts`;

        const grouped = accs.reduce((map, account) => {
          if (!map[account.platform]) map[account.platform] = [];
          map[account.platform].push(account);
          return map;
        }, {});

        const platformOrder = ["youtube", "tiktok", "facebook"];
        const cards = [];

        platformOrder.forEach(platform => {
          const meta = platformMeta[platform] || { name: platform, logo: "", iconBg: "#ffffff" };
          const list = grouped[platform] || [];

          if (list.length === 0) {
            cards.push(`
              <div class="card account-card">
                <div class="icon platform-icon" style="background:${meta.iconBg};">
                  ${meta.logo ? `<img class="platform-icon-img" src="${meta.logo}" alt="${meta.name} logo">` : meta.name[0]}
                </div>
                <div class="card-text">
                  <strong>${meta.name}</strong>
                  <div class="platform-row">
                    <span class="platform-label">
                      ${meta.logo ? `<img class="platform-logo" src="${meta.logo}" alt="${meta.name} logo">` : ""}
                      <span class="platform-name">${meta.name}</span>
                    </span>
                    <span class="status status-disconnected">
                      <span class="status-dot"></span>
                      Disconnected
                    </span>
                  </div>
                </div>
                <button class="btn-ghost" disabled>Not Signed In</button>
              </div>
            `);
            return;
          }

          list.forEach(account => {
            cards.push(`
              <div class="card account-card">
                <div class="icon platform-icon" style="background:${meta.iconBg};">
                  ${meta.logo ? `<img class="platform-icon-img" src="${meta.logo}" alt="${meta.name} logo">` : meta.name[0]}
                </div>
                <div class="card-text">
                  <strong>${account.nickname || 'Linked Account'}</strong>
                  <div class="platform-row">
                    <span class="platform-label">
                      ${meta.logo ? `<img class="platform-logo" src="${meta.logo}" alt="${meta.name} logo">` : ""}
                      <span class="platform-name">${meta.name}</span>
                    </span>
                    <span class="status status-connected">
                      <span class="status-dot"></span>
                      Connected
                    </span>
                  </div>
                </div>
                <button class="btn-ghost" onclick="removeAccount(${account.id})">Remove</button>
              </div>
            `);
          });
        });

        document.getElementById("accountList").innerHTML = cards.join("");
      } catch (err) {
        console.error("Failed to render accounts:", err);
      }
    }

    async function removeAccount(accountId) {
      if (!accountId) return;
      const confirmRemove = confirm("Remove this linked account? You can reconnect anytime.");
      if (!confirmRemove) return;

      try {
        await fetch(`${apiBase}/delete-account`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: accountId, user_id: userScope }),
        });
        await render();
      } catch (err) {
        console.error("Failed to remove account:", err);
        alert("Failed to remove account. Please try again.");
      }
    }

    /**
     * Triggers the OAuth flow for the selected platform
     */
    async function addAccount() {
      const platform = document.getElementById("platformSelect").value;
      
      if (!fId) {
        alert("Error: No Workspace ID found. Please go back to the home screen.");
        return;
      }

      // We redirect to the Worker's auth endpoint. 
      // The Worker handles the login and redirects back here automatically.
      // We pass folder_id as 'state' to keep track of where the user belongs.
      const authUrl = `${apiBase}/auth/${platform}?folder_id=${fId}&user_id=${encodeURIComponent(userScope)}`;
      
      // Navigate to the platform login (YouTube/TikTok/Facebook)
      window.location.href = authUrl;
    }

    // Run render on page load
    window.onload = render;
  </script>
</body>
</html>
