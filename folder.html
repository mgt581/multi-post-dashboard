<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Folder View</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <a href="index.html">←</a> 
      <span class="title" id="title">Folder</span>
    </header>
    
    <div class="card" style="margin:20px;">
      <strong id="name">Name</strong><br>
      <span id="count">0 accounts</span>
    </div>

    <section class="cards" id="accountList"></section>

    <div class="card" style="display:flex; gap:10px; margin:20px;">
      <select id="platformSelect" style="flex:1;">
        <option value="tiktok">TikTok</option>
        <option value="youtube">YouTube</option>
        <option value="facebook">Facebook</option>
      </select>
      <button onclick="addAccount()">Add</button>
    </div>

    <button class="card" style="width:90%; margin: 0 auto; display:block; background:#2fa84f; color:white;" onclick="location.href='create-post.html'">✏️ Create Post</button>
  </div>

  <script>
    // --- CONFIGURATION ---
    const apiBase = "https://multipost-seo-worker.alexbryant.workers.dev/api";
    const userScope = localStorage.getItem("currentUserKey") || "guest";
    const scopedKey = name => `${name}:${userScope}`;

    // Migrate legacy unscoped keys so existing users keep their context
    const legacyId = localStorage.getItem("activeFolderId");
    if (!localStorage.getItem(scopedKey("activeFolderId")) && legacyId) {
      localStorage.setItem(scopedKey("activeFolderId"), legacyId);
      localStorage.removeItem("activeFolderId");
    }

    const legacyName = localStorage.getItem("activeFolderName");
    if (!localStorage.getItem(scopedKey("activeFolderName")) && legacyName) {
      localStorage.setItem(scopedKey("activeFolderName"), legacyName);
      localStorage.removeItem("activeFolderName");
    }

    const fId = localStorage.getItem(scopedKey("activeFolderId"));
    const activeFolderName = localStorage.getItem(scopedKey("activeFolderName")) || "Folder";

    // UI Initialization
    document.getElementById("title").innerText = activeFolderName;
    document.getElementById("name").innerText = activeFolderName;

    if (!fId) {
      alert("No workspace selected for this account. Please pick a workspace from the home screen.");
      window.location.href = "index.html";
    }

    /**
     * Renders the accounts linked to this folder
     */
    async function render() {
      if (!fId) {
        console.error("No active folder ID found in localStorage.");
        return;
      }
      
      try {
        const res = await fetch(`${apiBase}/get-accounts?folder_id=${fId}`);
        const accs = await res.json();
        
        document.getElementById("count").innerText = `${accs.length} accounts`;
        
        document.getElementById("accountList").innerHTML = accs.map(a => `
          <div class="card">
            <div class="icon">${a.platform[0].toUpperCase()}</div>
            <div class="card-text">
              <strong>${a.nickname || 'Linked Account'}</strong>
              <span>${a.platform}</span>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error("Failed to render accounts:", err);
      }
    }

    /**
     * Triggers the OAuth flow for the selected platform
     */
    async function addAccount() {
      const platform = document.getElementById("platformSelect").value;
      
      if (!fId) {
        alert("Error: No Workspace ID found. Please go back to the home screen.");
        return;
      }

      // We redirect to the Worker's auth endpoint. 
      // The Worker handles the login and redirects back here automatically.
      // We pass folder_id as 'state' to keep track of where the user belongs.
      const authUrl = `${apiBase}/auth/${platform}?folder_id=${fId}`;
      
      // Navigate to the platform login (YouTube/TikTok/Facebook)
      window.location.href = authUrl;
    }

    // Run render on page load
    window.onload = render;
  </script>
</body>
</html>
