<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workspace Details | MultiPost</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Adding some inline safety styles in case styles.css is missing */
    .icon.youtube { background: #ff0000; color: white; }
    .icon.tiktok { background: #000000; color: white; }
    .icon.facebook { background: #1877f2; color: white; }
    .icon.instagram { background: #e4405f; color: white; }
    .card { cursor: pointer; transition: background 0.2s; }
    .card:hover { background: #f9f9f9; }
  </style>
</head>
<body>

<div class="app">

  <header class="header">
    <a href="index.html" class="gear" style="text-decoration:none; font-size:20px;">←</a>
    <span class="title" id="folderTitle">Loading...</span>
    <span></span>
  </header>

  <section class="cards">
    <div class="card" style="cursor: default;">
      <div class="card-text">
        <strong id="folderName">Workspace</strong>
        <span id="folderCount">Checking cloud...</span>
      </div>
    </div>
  </section>

  <section class="cards" id="accountList"></section>

  <section class="cards">
    <div class="card" style="cursor: default;">
      <select id="platformSelect" style="flex:1; margin-right:10px; padding: 8px; border-radius: 6px;">
        <option value="">Select platform</option>
        <option value="facebook">Facebook</option>
        <option value="tiktok">TikTok</option>
        <option value="youtube">YouTube</option>
      </select>
      <button onclick="addAccount()" style="padding: 8px 16px; background: #fe2c55; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Link</button>
    </div>
  </section>

  <div class="card post" onclick="goToPostCreator()" style="margin-top: 20px; border: 2px solid #2fa84f;">
    <div class="icon green" style="background: #2fa84f; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">✏️</div>
    <div class="card-text">
      <strong>Create Viral Post</strong>
      <span>Generate AI SEO for this workspace</span>
    </div>
  </div>

</div>

<script>
  // 1. SET YOUR WORKER URL
  const API_URL = "https://multipost-seo-worker.alexbryant.workers.dev";
  
  // 2. GET ID FROM URL
  const urlParams = new URLSearchParams(window.location.search);
  const folderId = urlParams.get('id');

  if (!folderId) {
    alert("No Workspace ID found. Returning to Dashboard.");
    window.location.href = "index.html";
  }

  // 3. LOAD DATA FROM CLOUDFLARE
  async function loadData() {
    try {
      // Get accounts linked to this folder from D1
      const response = await fetch(`${API_URL}/api/get-accounts?folder_id=${folderId}`);
      const accounts = await response.json();

      document.getElementById("folderTitle").textContent = "Workspace Manager";
      document.getElementById("folderName").textContent = "Workspace #" + folderId;
      document.getElementById("folderCount").textContent = `${accounts.length} connected accounts`;

      renderAccounts(accounts);
    } catch (err) {
      console.error("Cloud Error:", err);
      document.getElementById("accountList").innerHTML = `<p style="color:red; text-align:center;">Failed to connect to Cloud Database.</p>`;
    }
  }

  // 4. RENDER ACCOUNTS
  function renderAccounts(accounts) {
    const accountList = document.getElementById("accountList");
    accountList.innerHTML = "";

    if (accounts.length === 0) {
      accountList.innerHTML = `
        <div class="card" style="cursor: default;">
          <div class="card-text">
            <strong>No accounts linked</strong>
            <span>Select a platform below to start</span>
          </div>
        </div>
      `;
      return;
    }

    accounts.forEach(acc => {
      const div = document.createElement("div");
      div.className = "card";
      div.style.cursor = "default";

      div.innerHTML = `
        <div class="icon ${acc.platform}" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold;">
          ${acc.platform[0].toUpperCase()}
        </div>
        <div class="card-text">
          <strong>${acc.nickname || 'Linked Account'}</strong>
          <span>Verified ${acc.platform}</span>
        </div>
      `;
      accountList.appendChild(div);
    });
  }

  // 5. REDIRECT TO AUTH (No more local push)
  function addAccount() {
    const platform = document.getElementById("platformSelect").value;
    if (!platform) return;
    
    // Redirects user to the Cloudflare Worker OAuth initiation path
    window.location.href = `${API_URL}/api/auth/${platform}?folder_id=${folderId}`;
  }

  function goToPostCreator() {
    window.location.href = `create-post.html?folder_id=${folderId}`;
  }

  // Run on load
  loadData();
</script>

</body>
</html>
